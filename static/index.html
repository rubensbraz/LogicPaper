<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DocGenius | Auto-Docs</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“„</text></svg>">
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'sans-serif'],
                            mono: ['JetBrains Mono', 'monospace'],
                        },
                        colors: {
                            glass: "rgba(255, 255, 255, 0.05)",
                            glassBorder: "rgba(255, 255, 255, 0.1)",
                            neonBlue: "#3b82f6",
                            neonGreen: "#10b981",
                            darkBg: "#0B0C15"
                        }
                    }
                }
            }
        </script>
        <style>
            body {
                background-color: #0B0C15;
                background-image:
                    radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                    radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                    radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
                color: #e2e8f0;
            }

            .glass-panel {
                background: rgba(17, 25, 40, 0.75);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.125);
            }

            .drop-zone {
                transition: all 0.3s ease;
            }

            .drop-zone.drag-over {
                border-color: #3b82f6;
                background: rgba(59, 130, 246, 0.1);
                transform: scale(1.02);
            }

            /* Custom Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
            }

            ::-webkit-scrollbar-track {
                background: #0f172a;
            }

            ::-webkit-scrollbar-thumb {
                background: #334155;
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: #475569;
            }
        </style>
    </head>

    <body class="min-h-screen p-4 md:p-8 flex flex-col items-center">
        <header class="w-full max-w-7xl flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-lg flex items-center justify-center font-bold text-xl shadow-lg shadow-blue-500/20">D</div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">DocGenius <span class="text-blue-400">PRO</span></h1>
                    <p class="text-xs text-gray-400 font-mono">BATCH PROCESSING ENGINE v1.0</p>
                </div>
            </div>
            <div class="text-xs text-gray-500 font-mono flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> SYSTEM OPERATIONAL
            </div>
        </header>
        <main class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-5 space-y-6">
                <div class="glass-panel rounded-2xl p-6 shadow-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-sm font-bold text-blue-400 uppercase tracking-wider">1. Ingestion</h2>
                        <span class="text-xs text-gray-500">Drag & Drop Enabled</span>
                    </div>
                    <div class="space-y-3">
                        <label id="dropExcel" class="drop-zone block border border-dashed border-gray-600 rounded-xl p-4 cursor-pointer group">
                            <input type="file" id="fileExcel" class="hidden" accept=".xlsx" onchange="updateUI(this)">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-green-900/30 text-green-400 rounded-lg group-hover:scale-110 transition">ðŸ“Š</div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-gray-200">Data Source (.xlsx)</div>
                                    <div id="lblExcel" class="text-xs text-gray-500">Required</div>
                                </div>
                            </div>
                        </label>
                        <label id="dropTemplates" class="drop-zone block border border-dashed border-gray-600 rounded-xl p-4 cursor-pointer group">
                            <input type="file" id="fileTemplates" class="hidden" accept=".docx,.pptx" multiple onchange="updateUI(this)">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-blue-900/30 text-blue-400 rounded-lg group-hover:scale-110 transition">ðŸ“„</div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-gray-200">Templates (Word/PPT)</div>
                                    <div id="lblTemplates" class="text-xs text-gray-500">Select multiple files...</div>
                                </div>
                            </div>
                        </label>
                        <label id="dropAssets" class="drop-zone block border border-dashed border-gray-600 rounded-xl p-4 cursor-pointer group">
                            <input type="file" id="fileAssets" class="hidden" accept=".zip" onchange="updateUI(this)">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-purple-900/30 text-purple-400 rounded-lg group-hover:scale-110 transition">ðŸ“¦</div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-gray-200">Assets Library (.zip)</div>
                                    <div id="lblAssets" class="text-xs text-gray-500">Optional (Images)</div>
                                </div>
                            </div>
                        </label>
                    </div>
                    <button onclick="previewData()" class="mt-6 w-full py-3 bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2 group">
                        <span>Analyze Source</span>
                        <span class="group-hover:translate-x-1 transition">â†’</span>
                    </button>
                </div>
                <div id="configPanel" class="glass-panel rounded-2xl p-6 shadow-2xl opacity-50 pointer-events-none transition-all duration-500">
                    <h2 class="text-sm font-bold text-blue-400 uppercase tracking-wider mb-4">2. Configuration</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-mono text-gray-400 mb-1">FILENAME IDENTIFIER COLUMN</label>
                            <select id="colSelect" class="w-full bg-black/30 border border-gray-600 rounded-lg p-2.5 text-sm text-white focus:border-blue-500 outline-none transition">
                                <option>Waiting for analysis...</option>
                            </select>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 p-3 rounded-lg border border-white/5">
                            <span class="text-sm">Convert Output to PDF</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="checkPDF" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between bg-black/20 p-3 rounded-lg border border-white/5">
                            <div class="flex flex-col">
                                <span class="text-sm">Group Files in Folders</span>
                                <span class="text-[10px] text-gray-500">Create folder for each identifier?</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="checkFolders" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                        <button onclick="startProcessing()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl font-bold shadow-lg shadow-blue-900/40 transform hover:scale-[1.02] transition-all flex items-center justify-center gap-2">
                            <span>ðŸš€ Start Processing</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-7 flex flex-col gap-6">
                <div class="glass-panel rounded-2xl p-1 flex-1 min-h-[200px] flex flex-col">
                    <div class="bg-black/40 px-4 py-2 rounded-t-xl border-b border-white/5 flex justify-between items-center">
                        <span class="text-xs font-mono text-gray-400">DATA_PREVIEW.JSON</span>
                        <span class="text-[10px] bg-gray-800 px-2 py-0.5 rounded text-gray-300">READ-ONLY</span>
                    </div>
                    <div class="relative flex-1 bg-black/20 overflow-hidden rounded-b-xl">
                        <pre id="jsonPreview" class="absolute inset-0 p-4 text-xs font-mono text-green-400 overflow-auto scrollbar-thin">awaiting_input...</pre>
                    </div>
                </div>
                <div class="glass-panel rounded-2xl p-1 h-[300px] flex flex-col relative overflow-hidden">
                    <div class="absolute inset-0 pointer-events-none bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10"></div>
                    <div class="bg-black/60 px-4 py-2 rounded-t-xl border-b border-white/5 flex justify-between items-center z-10">
                        <span class="text-xs font-mono text-blue-400">>_ SYSTEM_LOGS</span>
                        <div class="flex gap-1.5">
                            <div class="w-2.5 h-2.5 rounded-full bg-red-500/50"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/50"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
                        </div>
                    </div>
                    <div id="terminal" class="flex-1 bg-black/80 p-4 font-mono text-xs text-gray-300 overflow-y-auto z-10">
                        <div class="text-gray-600 italic">System ready. Waiting for batch command...</div>
                    </div>
                    <div id="downloadOverlay" class="absolute inset-0 bg-black/80 backdrop-blur-sm z-20 flex items-center justify-center hidden flex-col">
                        <div class="text-green-400 text-4xl mb-2">âœ”</div>
                        <h3 class="text-xl font-bold text-white mb-4">Batch Completed</h3>
                        <a id="downloadLink" href="#" class="px-8 py-3 bg-white text-black font-bold rounded-full hover:bg-gray-200 transition shadow-xl hover:shadow-2xl hover:scale-105"> Download ZIP Archive </a>
                        <button onclick="location.reload()" class="mt-4 text-xs text-gray-500 hover:text-white underline">Start New Batch</button>
                    </div>
                </div>
            </div>
        </main>
        <script>
            let sessionId = crypto.randomUUID();

            // --- DRAG AND DROP LOGIC ---

            function setupDragDrop(elementId) {
                const dropZone = document.getElementById(elementId);
                const input = dropZone.querySelector('input');

                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });

                // Highlight drop zone
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
                });

                // Handle Drop
                dropZone.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;

                    if (files.length > 0) {
                        input.files = files; // Manually assign files to input
                        updateUI(input);
                    }
                }, false);
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Initialize Drag & Drop for all zones
            setupDragDrop('dropExcel');
            setupDragDrop('dropTemplates');
            setupDragDrop('dropAssets');

            // --- UI LOGIC ---

            function updateUI(input) {
                // Find label associated
                // ID convention: fileX -> lblX
                const labelId = input.id.replace('file', 'lbl');
                const label = document.getElementById(labelId);

                if (input.files && input.files.length > 0) {
                    if (input.files.length === 1) {
                        label.innerText = input.files[0].name;
                    } else {
                        label.innerText = `${input.files.length} files selected`;
                    }
                    label.classList.add('text-blue-400');
                    label.classList.remove('text-gray-500');
                }
            }

            async function previewData() {
                const fileExcel = document.getElementById('fileExcel').files[0];
                if (!fileExcel) return Swal.fire({ icon: 'error', title: 'Missing Input', text: 'Please upload an Excel file first.', background: '#1e293b', color: '#fff' });

                const formData = new FormData();
                formData.append('file_excel', fileExcel);

                document.getElementById('jsonPreview').innerText = "Scanning file structure...";

                try {
                    const res = await fetch('/api/preview', { method: 'POST', body: formData });
                    const data = await res.json();

                    if (data.status === 'success') {
                        const configPanel = document.getElementById('configPanel');
                        configPanel.classList.remove('opacity-50', 'pointer-events-none');
                        document.getElementById('jsonPreview').innerText = JSON.stringify(data.preview, null, 2);

                        const sel = document.getElementById('colSelect');
                        sel.innerHTML = '<option value="">-- Select Identifier Column --</option>';
                        data.headers.forEach(h => {
                            let opt = document.createElement('option');
                            opt.value = h;
                            opt.innerText = h;
                            sel.appendChild(opt);
                        });
                    } else {
                        throw new Error(data.message);
                    }
                } catch (e) {
                    Swal.fire({ icon: 'error', title: 'Analysis Failed', text: e.message, background: '#1e293b', color: '#fff' });
                    document.getElementById('jsonPreview').innerText = "Error: " + e.message;
                }
            }

            function startProcessing() {
                const fileExcel = document.getElementById('fileExcel').files[0];
                const fileTemplates = document.getElementById('fileTemplates').files;
                const fileAssets = document.getElementById('fileAssets').files[0];
                const colName = document.getElementById('colSelect').value;
                const toPdf = document.getElementById('checkPDF').checked;
                const groupFolders = document.getElementById('checkFolders').checked; // NEW

                if (fileTemplates.length === 0) return Swal.fire({ icon: 'warning', title: 'No Templates', text: 'Please select at least one Word/PPT template.', background: '#1e293b', color: '#fff' });
                if (!colName) return Swal.fire({ icon: 'warning', title: 'Configuration Missing', text: 'Please select a column to name the output folders.', background: '#1e293b', color: '#fff' });

                // Setup SSE
                const terminal = document.getElementById('terminal');
                terminal.innerHTML = '';
                const evtSource = new EventSource(`/stream-logs/${sessionId}`);

                evtSource.onmessage = function (event) {
                    const p = document.createElement('div');
                    p.className = "mb-1 border-l-2 border-transparent pl-2 hover:bg-white/5 transition-colors";

                    if (event.data.includes("ERROR")) {
                        p.classList.add('text-red-400', 'border-red-500');
                        p.innerText = event.data;
                    } else if (event.data.includes("âœ…")) {
                        p.classList.add('text-green-400', 'border-green-500');
                        p.innerText = event.data;
                    } else {
                        p.innerText = `> ${event.data}`;
                    }

                    terminal.appendChild(p);
                    terminal.scrollTop = terminal.scrollHeight;

                    if (event.data.includes("PROCESS_COMPLETE")) {
                        evtSource.close();
                        document.getElementById('downloadOverlay').classList.remove('hidden');
                        document.getElementById('downloadOverlay').classList.add('flex');
                    } else if (event.data.includes("PROCESS_ERROR")) {
                        evtSource.close();
                    }
                };

                // Build FormData
                const formData = new FormData();
                formData.append('session_id', sessionId);
                formData.append('filename_col', colName);
                formData.append('output_pdf', toPdf);
                formData.append('group_by_folders', groupFolders);
                formData.append('file_excel', fileExcel);

                for (let i = 0; i < fileTemplates.length; i++) {
                    formData.append('files_templates', fileTemplates[i]);
                }

                if (fileAssets) formData.append('file_assets', fileAssets);

                fetch('/api/process', { method: 'POST', body: formData })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            document.getElementById('downloadLink').href = data.download_url;
                        }
                    });
            }
        </script>
    </body>

</html>